{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "TimeZone": {
            "type": "string",
            "defaultValue": "Eastern Standard Time",
            "allowedValues": [
                "Afghanistan Standard Time",
                "Alaskan Standard Time",
                "Aleutian Standard Time",
                "Altai Standard Time",
                "Arab Standard Time",
                "Arabian Standard Time",
                "Arabic Standard Time",
                "Argentina Standard Time",
                "Astrakhan Standard Time",
                "Atlantic Standard Time",
                "AUS Central Standard Time",
                "Aus Central W. Standard Time",
                "AUS Eastern Standard Time",
                "Azerbaijan Standard Time",
                "Azores Standard Time",
                "Bahia Standard Time",
                "Bangladesh Standard Time",
                "Belarus Standard Time",
                "Bougainville Standard Time",
                "Canada Central Standard Time",
                "Cape Verde Standard Time",
                "Caucasus Standard Time",
                "Cen. Australia Standard Time",
                "Central America Standard Time",
                "Central Asia Standard Time",
                "Central Brazilian Standard Time",
                "Central Europe Standard Time",
                "Central European Standard Time",
                "Central Pacific Standard Time",
                "Central Standard Time (Mexico)",
                "Central Standard Time",
                "Chatham Islands Standard Time",
                "China Standard Time",
                "Cuba Standard Time",
                "Dateline Standard Time",
                "E. Africa Standard Time",
                "E. Australia Standard Time",
                "E. Europe Standard Time",
                "E. South America Standard Time",
                "Easter Island Standard Time",
                "Eastern Standard Time (Mexico)",
                "Eastern Standard Time",
                "Egypt Standard Time",
                "Ekaterinburg Standard Time",
                "Fiji Standard Time",
                "FLE Standard Time",
                "Georgian Standard Time",
                "GMT Standard Time",
                "Greenland Standard Time",
                "Greenwich Standard Time",
                "GTB Standard Time",
                "Haiti Standard Time",
                "Hawaiian Standard Time",
                "India Standard Time",
                "Iran Standard Time",
                "Israel Standard Time",
                "Jordan Standard Time",
                "Kaliningrad Standard Time",
                "Korea Standard Time",
                "Libya Standard Time",
                "Line Islands Standard Time",
                "Lord Howe Standard Time",
                "Magadan Standard Time",
                "Magallanes Standard Time",
                "Marquesas Standard Time",
                "Mauritius Standard Time",
                "Middle East Standard Time",
                "Montevideo Standard Time",
                "Morocco Standard Time",
                "Mountain Standard Time (Mexico)",
                "Mountain Standard Time",
                "Myanmar Standard Time",
                "N. Central Asia Standard Time",
                "Namibia Standard Time",
                "Nepal Standard Time",
                "New Zealand Standard Time",
                "Newfoundland Standard Time",
                "Norfolk Standard Time",
                "North Asia East Standard Time",
                "North Asia Standard Time",
                "North Korea Standard Time",
                "Omsk Standard Time",
                "Pacific SA Standard Time",
                "Pacific Standard Time (Mexico)",
                "Pacific Standard Time",
                "Pakistan Standard Time",
                "Paraguay Standard Time",
                "Qyzylorda Standard Time",
                "Romance Standard Time",
                "Russia Time Zone 10",
                "Russia Time Zone 11",
                "Russia Time Zone 3",
                "Russian Standard Time",
                "SA Eastern Standard Time",
                "SA Pacific Standard Time",
                "SA Western Standard Time",
                "Saint Pierre Standard Time",
                "Sakhalin Standard Time",
                "Samoa Standard Time",
                "Sao Tome Standard Time",
                "Saratov Standard Time",
                "SE Asia Standard Time",
                "Singapore Standard Time",
                "South Africa Standard Time",
                "Sri Lanka Standard Time",
                "Sudan Standard Time",
                "Syria Standard Time",
                "Taipei Standard Time",
                "Tasmania Standard Time",
                "Tocantins Standard Time",
                "Tokyo Standard Time",
                "Tomsk Standard Time",
                "Tonga Standard Time",
                "Transbaikal Standard Time",
                "Turkey Standard Time",
                "Turks And Caicos Standard Time",
                "Ulaanbaatar Standard Time",
                "US Eastern Standard Time",
                "US Mountain Standard Time",
                "UTC",
                "UTC+12",
                "UTC+13",
                "UTC-02",
                "UTC-08",
                "UTC-09",
                "UTC-11",
                "Venezuela Standard Time",
                "Vladivostok Standard Time",
                "Volgograd Standard Time",
                "W. Australia Standard Time",
                "W. Central Africa Standard Time",
                "W. Europe Standard Time",
                "W. Mongolia Standard Time",
                "West Asia Standard Time",
                "West Bank Standard Time",
                "West Pacific Standard Time",
                "Yakutsk Standard Time"
            ],
            "metadata": {
                "description": "Time Zone"
            }
        },
        "AzureADDomainServicesSku": {
            "defaultValue": "Standard",      
            "allowedValues": [
                "Standard",
                "Enterprise",
                "Premium"
            ],
            "type": "String",
            "metadata": {
                "description": "Azure Active Directory Domain Services Sku"
            }
        },   
        "hostpoolType": {
            "defaultValue": "Pooled",      
            "allowedValues": [
                "Pooled",
                "Personal"
            ],
            "type": "String",
            "metadata": {
                "description": "Set this parameter to Personal if you would like to enable Persistent Desktop experience. Defaults to false."
            }
        },    
        "personalDesktopAssignmentType": {
            "defaultValue": "Automatic",
            "allowedValues": [
                "Automatic",
                "Direct",
                ""
            ],
            "type": "String",
            "metadata": {
                "description": "Set the type of assignment for a Personal hostpool type"
            }
        },    
        "maxSessionLimit": {
            "defaultValue": 99999,
            "type": "Int",
            "metadata": {
                "description": "Maximum number of sessions."
            }
        },     
        "loadBalancerType": {
            "defaultValue": "BreadthFirst",
            "allowedValues": [
                "BreadthFirst",
                "DepthFirst",
                "Persistent"
            ],
            "type": "String",
            "metadata": {
                "description": "Type of load balancer algorithm."
            }
        },          
        "validationEnvironment": {
            "defaultValue": false,
            "type": "Bool",
            "metadata": {
                "description": "Whether to use validation enviroment."
            }
        },         
        "vmDiskType": {
            "defaultValue": "StandardSSD_LRS",
            "allowedValues": [
                "Premium_LRS",
                "StandardSSD_LRS",
                "Standard_LRS"
            ],
            "type": "String",
            "metadata": {
                "description": "The VM disk type for the VM: HDD or SSD."
            }
        },
        "vmnumberofInstances": {
            "defaultValue": 2,
            "type": "int",
            "metadata": {
                "description": "Enter the number of WVD Session Hosts."
            }
        },    
        "vmInitialNumber": {
            "defaultValue": 0,
            "type": "int",
            "metadata": {
                "description": "VM name prefix initial number."
            }
        },   
        "availabilitySetUpdateDomainCount": {
            "defaultValue": 5,
            "allowedValues": [
                1,
                2,
                3,
                4,
                5,
                6,
                7,
                8,
                9,
                10,
                11,
                12,
                13,
                14,
                15,
                16,
                17,
                18,
                19,
                20
            ],
            "type": "Int",
            "metadata": {
                "description": "The platform update domain count of avaiability set to be created."
            }
        },
        "availabilitySetFaultDomainCount": {
            "defaultValue": 2,
            "allowedValues": [
                1,
                2,
                3
            ],
            "type": "Int",
            "metadata": {
                "description": "The platform fault domain count of avaiability set to be created."
            }
        },                      
        "adminUsername": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "The name of the Administrator of the new VM and Domain"
            }
        },
        "adminPassword": {
            "type": "securestring",
            "metadata": {
                "description": "The password for the Administrator account of the new VM and Domain"
            }
        },
        "AzureUserName": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "Azure User Principal with AAD DC Administrators rights"
            }
        },
        "AzureUserPassword": {
            "type": "securestring",
            "metadata": {
                "description": "Azure User Password"
            }
        },
        "ManagedDomainName": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "Azure Managed Domain (Example:  killerhomelab.onmicrosoft.com or killerhomelab.onmicrosoft.us)"
            }
        },
        "AzureADDomainServicesDomain": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "NetBios Domain Name (Example: killerhomelab.com)"
            }
        },                                    		        
        "AzureUserObjectID": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "Deployment Account Object ID"
            }
        },
        "AVDGroupObjectID": {
            "defaultValue": "",        
            "type": "string",
            "metadata": {
                "description": "Object ID of Group that requires AVD Access"
            }
        },        
        "WindowsClientLicenseType": {
            "type": "string",
            "defaultValue": "None",
            "allowedValues": [
                "None",
                "Windows_Client"
            ],      
            "metadata": {
                "description": "Windows Client OS License Type"
            }
        },              
        "NamingConvention": {
            "type": "string",
            "defaultValue": "khl",
            "maxLength": 4,
            "metadata": {
                "description": "VNet1 Name"
            }
        },
        "vnet1ID": {
            "type": "string",
            "defaultValue": "172.16",
            "metadata": {
                "description": "VNet1 Prefix"
            }
        },            
        "roleAssignmentGuid1": {
            "type": "string",
            "defaultValue": "[newGuid()]",
            "metadata": {
                "description": "A new GUID used to identify the role assignment"
            }
        },   
        "roleAssignmentGuid2": {
            "type": "string",
            "defaultValue": "[newGuid()]",
            "metadata": {
                "description": "A new GUID used to identify the role assignment"
            }
        },
        "WVDTokenPhrase": {
            "defaultValue": "[newGuid()]",
            "type": "string",
                "metadata": {
                "description": "PassPhrase to generate Registration Key"
            }
        },        
        "BaseTime": {
            "defaultValue": "[utcNow('u')]",
            "type": "String",
            "metadata": {
                "description": "Hostpool token expiration time"
            }
        },                                                   
        "SHOSSku": {
            "type": "string",
            "defaultValue": "win11-21h2-avd-m365",
            "allowedValues": [
                "win11-21h2-avd-m365",
                "win10-21h2-avd-m365"
            ],
            "metadata": {
                "description": "Session Host Operating System"
            }
        },    
        "SHOSVersion": {
            "type": "string",
            "defaultValue": "latest",
            "metadata": {
                "description": "Session Host OS Version Number (Example:  22000.675.220510, Windows-10=19044.1706.220510)"
            }
        },       
        "SHVMSize": {
            "type": "string",
            "defaultValue": "Standard_D2s_v3",
            "metadata": {
                "description": "Session Host VMSize"
            }
        },                
        "_artifactsLocation": {
            "type": "string",
            "metadata": {
                "description": "The location of resources, such as templates and DSC modules, that the template depends on"
            },
            "defaultValue": "https://raw.githubusercontent.com/elliottfieldsjr/KillerHomeLab-ARM/comingsoon/"
        },
        "_artifactsLocationSasToken": {
            "type": "securestring",
            "metadata": {
                "description": "Auto-generated token to access _artifactsLocation. Leave it blank unless you need to provide your own value."
            },
            "defaultValue": ""
        }
    },
    "variables": {
        "DeploymentName": "[deployment().name]",
        "Identifier": "[substring(variables('DeploymentName'), 19, 14)]",
        "KeyVaultName": "[concat('AVDAADD-', variables('Identifier'))]",
        "SecretName": "[concat(resourceGroup().Name,'-Password')]",
        "vnet1Name": "[concat(parameters('NamingConvention'),'-VNet1')]",
        "vnet1Prefix": "[concat(parameters('vnet1ID'),'.0.0/16')]",
        "vnet1subnet1Name": "[concat(parameters('NamingConvention'),'-VNet1-Subnet1')]",
        "vnet1subnet1Prefix": "[concat(parameters('vnet1ID'),'.1.0/24')]",
        "vnet1subnet2Name": "[concat(parameters('NamingConvention'),'-VNet1-Subnet2')]",
        "vnet1subnet2Prefix": "[concat(parameters('vnet1ID'),'.2.0/24')]",
        "vnet1GatewaysubnetPrefix": "[concat(parameters('vnet1ID'),'.0.0/24')]",
        "vnet1BastionsubnetPrefix": "[concat(parameters('vnet1ID'),'.253.0/24')]",
        "vnet1FirewallsubnetPrefix": "[concat(parameters('vnet1ID'),'.254.0/24')]",    
        "aaddsIP1": "[concat(parameters('vnet1ID'),'.1.4')]", 
        "aaddsIP2": "[concat(parameters('vnet1ID'),'.1.5')]", 
        "aaddrdshPrefix": "[concat(parameters('NamingConvention'),'-aaddsh-')]",   
        "AADDHostPoolName": "[concat(parameters('NamingConvention'),'-AADD-Hosted-Pool')]",
        "AADDDesktopAppGroupName": "[concat(variables('AADDHostPoolName'),'-AADD-DAG')]",    
        "AADDRemoteAppGroupName": "[concat(variables('AADDHostPoolName'),'-AADD-RAG')]",
        "AADDAvailabilitySetName": "[concat(variables('AADDHostPoolName'),'-AADD-AVSet')]",                          
        "AADDHostPoolARMPath": "[resourceId(resourceGroup().name, 'Microsoft.DesktopVirtualization/hostpools', variables('AADDHostPoolName'))]",        
        "AADDSessionHostTemplate": "[concat('{\"domain\":\"',parameters('AzureADDomainServicesDomain'), '\",\"galleryImageOffer\":\"office-365\",\"galleryImagePublisher\":\"MicrosoftWindowsDesktop\",\"galleryImageSKU\":\"',parameters('SHOSSku'),'\",\"imageType\":\"Gallery\",\"imageUri\":null,\"customImageId\":null,\"namePrefix\":\"', parameters('NamingConvention'),'\",\"osDiskType\":\"',parameters('vmDiskType'),'\",\"useManagedDisks\":true,\"vmSize\":{\"id\":\"',parameters('SHVMSize'),'\",\"cores\":2,\"ram\":8},\"galleryItemId\":\"MicrosoftWindowsDesktop.office-365',parameters('SHOSSku'),'\"}')]",                
        "WorkSpaceName": "[concat(variables('AADDHostPoolName'),'-WorkSpace')]",      
        "NSG1Name": "[concat(parameters('NamingConvention'),'-nsg01')]" ,                      
        "RoleDefinitionID": "1d18fff3-a72a-46b5-b4a9-0b38a3cd7e63",
        "Ring": 1,
        "add4Hours": "[dateTimeAdd(parameters('baseTime'), 'PT4H')]",
        "AvailabilitySetsAPIVersion": "2022-03-01",
        "AVDHostPoolAPIVersion": "2022-02-10-preview",              
        "AVDApplicationGroupAPIVersion": "2022-02-10-preview",
        "AVDApplicationGroupAuthorizationAPIVersion": "2022-01-01-preview",
        "AVDWorkSpaceAPIVersion": "2022-02-10-preview",
        "AzureADDSAPIVersion": "2021-05-01",
        "DeploymentAPIVersion": "2021-04-01",
        "ExtensionsAPIVersion": "2022-03-01",
        "KeyVaultAPIVersion": "2021-11-01-preview",
        "KeyVaultSecretAPIVersion": "2021-11-01-preview",
        "NetworkInterfacesAPIVersion": "2021-08-01",
        "NetworkSecurityGroupAPIVersion": "2022-01-01",                
        "VirtualMachinesAPIVersion": "2022-03-01",
        "VirtualNetworkAPIVersion": "2020-11-01",        
        "ExtensionsTypeHandlerVersion": "2.83",
        "DJExtensionsTypeHandlerVersion": "1.3"
    },
    "resources": [
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Deploy-Password-KeyVault-with-Secret",
            "Properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/keyvaultwithsecret.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "KeyVaultAPIVersion": {
                        "value": "[variables('KeyVaultAPIVersion')]"
                    },
                    "KeyVaultSecretAPIVersion": {
                        "value": "[variables('KeyVaultSecretAPIVersion')]"
                    },
                    "KeyVaultName": {
                        "value": "[variables('KeyVaultName')]"
                    },
                    "SecretName": {
                        "value": "[variables('SecretName')]"
                    },
                    "SecretValue": {
                        "value": "[parameters('adminPassword')]"
                    },
                    "AzureUserObjectID": {
                        "value": "[parameters('AzureUserObjectID')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Deploy-VirtualNetwork-01",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/vnet.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "VirtualNetworkAPIVersion": {
                        "value": "[variables('VirtualNetworkAPIVersion')]"
                    },
                    "vnetName": {
                        "value": "[variables('vnet1Name')]"
                    },
                    "vnetprefix": {
                        "value": "[variables('vnet1Prefix')]"
                    },
                    "subnet1Name": {
                        "value": "[variables('vnet1subnet1Name')]"
                    },
                    "subnet1Prefix": {
                        "value": "[variables('vnet1subnet1Prefix')]"
                    },
                    "subnet2Name": {
                        "value": "[variables('vnet1subnet2Name')]"
                    },
                    "subnet2Prefix": {
                        "value": "[variables('vnet1subnet2Prefix')]"
                    },
                    "GatewaysubnetPrefix": {
                        "value": "[variables('vnet1GatewaysubnetPrefix')]"
                    },                    
                    "BastionsubnetPrefix": {
                        "value": "[variables('vnet1BastionsubnetPrefix')]"
                    },
                    "FirewallsubnetPrefix": {
                        "value": "[variables('vnet1FirewallsubnetPrefix')]"
                    }                    
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Deploy-NetworksecurityGroup-01",
            "dependsOn": [
                "Deploy-VirtualNetwork-01"      
            ],      
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/aaddsnetworksecuritygroup.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "NetworkSecurityGroupAPIVersion": {
                        "value": "[variables('NetworkSecurityGroupAPIVersion')]"
                    },                    
                    "NetworkSecurityGroupname": {
                        "value": "[variables('NSG1Name')]"
                    }
                }
            }
        },                                   
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Associate-NSG-with-Subnet1",
            "dependsOn": [
                "Deploy-NetworksecurityGroup-01"
            ],            
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/associatesubnetnsg.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "VirtualNetworkAPIVersion": {
                        "value": "[variables('VirtualNetworkAPIVersion')]"
                    },                    
                    "vnetName": {
                        "value": "[variables('vnet1Name')]"
                    },
                    "subnetName": {
                        "value": "[variables('vnet1subnet1Name')]"
                    },                                                                                                            
                    "subnetPrefix": {
                        "value": "[variables('vnet1subnet1Prefix')]"
                    }, 
                    "NetworkSecurityGroupname": {
                        "value": "[variables('NSG1Name')]"
                    }                                                                                                                                                                                                                             
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Associate-NSG-with-Subnet2",
            "dependsOn": [
                "Associate-NSG-with-Subnet1"
            ],            
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/associatesubnetnsg.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "VirtualNetworkAPIVersion": {
                        "value": "[variables('VirtualNetworkAPIVersion')]"
                    },                    
                    "vnetName": {
                        "value": "[variables('vnet1Name')]"
                    },
                    "subnetName": {
                        "value": "[variables('vnet1subnet2Name')]"
                    },                                                                                                            
                    "subnetPrefix": {
                        "value": "[variables('vnet1subnet2Prefix')]"
                    }, 
                    "NetworkSecurityGroupname": {
                        "value": "[variables('NSG1Name')]"
                    }                                                                                                                                                                                                                             
                }
            }
        },        
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Deploy-AzureAD-DomainServices",
            "dependsOn": [
               "Associate-NSG-with-Subnet2"
            ],                        
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/azureaddomainservices.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "AzureADDSAPIVersion": {
                        "value": "[variables('AzureADDSAPIVersion')]"
                    },
                    "DomainName": {
                        "value": "[parameters('AzureADDomainServicesDomain')]"
                    },                    
                    "vnetName": {
                        "value": "[variables('vnet1Name')]"
                    },
                    "subnetName": {
                        "value": "[variables('vnet1subnet1Name')]"
                    },
                    "Sku": {
                        "value": "[parameters('AzureADDomainServicesSku')]"
                    }                                        
                }
            }
        },                
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Deploy-AzureVirtualDesktop-AADD-HostedPool",
            "dependsOn": [
               "Deploy-AzureAD-DomainServices"
            ],            
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/avdhostpoolaadd.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "AVDHostPoolAPIVersion": {
                        "value": "[variables('AVDHostPoolAPIVersion')]"
                    },                    
                    "HostPoolName": {
                        "value": "[variables('AADDHostPoolName')]"
                    },
                    "HostPoolType": {
                        "value": "[parameters('HostPoolType')]"
                    },
                    "personalDesktopAssignmentType": {
                        "value": "[parameters('personalDesktopAssignmentType')]"
                    },
                    "maxSessionLimit": {
                        "value": "[parameters('maxSessionLimit')]"
                    },
                    "loadBalancerType": {
                        "value": "[parameters('loadBalancerType')]"
                    },
                    "vmTemplate": {
                        "value": "[variables('AADDSessionHostTemplate')]"
                    },
                    "tokenExpirationTime": {
                        "value": "[variables('add4Hours')]"
                    },
                    "validationEnvironment": {
                        "value": "[parameters('validationEnvironment')]"
                    },
                    "Ring": {
                        "value": "[variables('Ring')]"
                    },
                    "Token": {
                        "value": "[parameters('WVDTokenPhrase')]"
                    }                                                                                                                   
                }
            }
        },                        
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Deploy-AzureVirtualDesktop-AADD-DesktopApplicationGroup",   
            "dependsOn": [
               "Deploy-AzureVirtualDesktop-AADD-HostedPool"
            ],   
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/avddesktopapplicationgroup.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "DeploymentAPIVersion": {
                        "value": "[variables('DeploymentAPIVersion')]"
                    },
                    "AVDApplicationGroupAPIVersion": {
                        "value": "[variables('AVDApplicationGroupAPIVersion')]"
                    },                    
                    "AppGroupName": {
                        "value": "[variables('AADDDesktopAppGroupName')]"
                    }, 
                    "NamingConvention": {
                        "value": "[parameters('NamingConvention')]"
                    },
                    "HostPoolARMPath": {
                        "value": "[variables('AADDHostPoolARMPath')]"
                    },
                    "RoleAssignmentGUID": {
                        "value": "[parameters('roleAssignmentGuid1')]"
                    },
                    "PrincipalID": {
                        "value": "[parameters('AVDGroupObjectID')]"
                    },
                    "RoleDefinitionID": {
                        "value": "[variables('RoleDefinitionID')]"
                    }                                                                                                                                                                                                                           
                }
            }
        },                
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Deploy-AzureVirtualDesktop-AADD-RemoteApplicationGroup",   
            "dependsOn": [
                "Deploy-AzureVirtualDesktop-AADD-DesktopApplicationGroup"
            ],   
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/avdremoteapplicationgroup.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "DeploymentAPIVersion": {
                        "value": "[variables('DeploymentAPIVersion')]"
                    },
                    "AVDApplicationGroupAPIVersion": {
                        "value": "[variables('AVDApplicationGroupAPIVersion')]"
                    },     
                    "AVDApplicationGroupAuthorizationAPIVersion": {
                        "value": "[variables('AVDApplicationGroupAuthorizationAPIVersion')]"
                    },                                         
                    "AppGroupName": {
                        "value": "[variables('AADDRemoteAppGroupName')]"
                    }, 
                    "NamingConvention": {
                        "value": "[parameters('NamingConvention')]"
                    },             
                    "HostPoolARMPath": {
                        "value": "[variables('AADDHostPoolARMPath')]"
                    },
                    "selectedApps": {
                        "value": [
                            {
                                "id": "[concat('/subscriptions/',subscription().id,'/resourcegroups/',resourceGroup().name, '/providers/Microsoft.DesktopVirtualization/applicationgroups/',variables('AADDRemoteAppGroupName'),'/applications/Excel')]",
                                "name": "Excel",
                                "type": "Microsoft.WindowsVirualDesktop/applicationGroups/applications",
                                "properties": {
                                    "applicationType": "Inbuilt",
                                    "friendlyName": "",
                                    "description": "",
                                    "filePath": "C:\\Program Files\\Microsoft Office\\root\\Office16\\EXCEL.EXE",
                                    "iconPath": "C:\\Program Files\\Microsoft Office\\Root\\VFS\\Windows\\Installer\\{90160000-000F-0000-1000-0000000FF1CE}\\xlicons.exe",
                                    "iconIndex": 0,
                                    "commandLineSetting": "DoNotAllow",
                                    "commandLineArguments": "",
                                    "showInPortal": true
                                }
                            },
                            {
                                "id": "[concat('/subscriptions/',subscription().id,'/resourcegroups/',resourceGroup().name, '/providers/Microsoft.DesktopVirtualization/applicationgroups/',variables('AADDRemoteAppGroupName'),'/applications/Microsoft Edge')]",
                                "name": "Microsoft Edge",
                                "type": "Microsoft.WindowsVirualDesktop/applicationGroups/applications",
                                "properties": {
                                    "applicationType": "Inbuilt",
                                    "friendlyName": "",
                                    "description": "",
                                    "filePath": "C:\\Program Files (x86)\\Microsoft\\Edge\\Application\\msedge.exe",
                                    "iconPath": "C:\\Program Files (x86)\\Microsoft\\Edge\\Application\\msedge.exe",
                                    "iconIndex": 0,
                                    "commandLineSetting": "DoNotAllow",
                                    "commandLineArguments": "",
                                    "showInPortal": true
                                }
                            },
                            {
                                "id": "[concat('/subscriptions/',subscription().id,'/resourcegroups/',resourceGroup().name, '/providers/Microsoft.DesktopVirtualization/applicationgroups/',variables('AADDRemoteAppGroupName'),'/applications/OneDrive')]",
                                "name": "OneDrive",
                                "type": "Microsoft.WindowsVirualDesktop/applicationGroups/applications",
                                "properties": {
                                    "applicationType": "Inbuilt",
                                    "friendlyName": "",
                                    "description": "",
                                    "filePath": "C:\\Program Files (x86)\\Microsoft OneDrive\\OneDrive.exe",
                                    "iconPath": "C:\\Program Files (x86)\\Microsoft OneDrive\\OneDrive.exe",
                                    "iconIndex": 1,
                                    "commandLineSetting": "DoNotAllow",
                                    "commandLineArguments": "",
                                    "showInPortal": true
                                }
                            },
                            {
                                "id": "[concat('/subscriptions/',subscription().id,'/resourcegroups/',resourceGroup().name, '/providers/Microsoft.DesktopVirtualization/applicationgroups/',variables('AADDRemoteAppGroupName'),'/applications/OneNote')]",                        
                                "name": "OneNote",
                                "type": "Microsoft.WindowsVirualDesktop/applicationGroups/applications",
                                "properties": {
                                    "applicationType": "Inbuilt",
                                    "friendlyName": "",
                                    "description": "",
                                    "filePath": "C:\\Program Files\\Microsoft Office\\root\\Office16\\ONENOTE.EXE",
                                    "iconPath": "C:\\Program Files\\Microsoft Office\\Root\\VFS\\Windows\\Installer\\{90160000-000F-0000-1000-0000000FF1CE}\\joticon.exe",
                                    "iconIndex": 0,
                                    "commandLineSetting": "DoNotAllow",
                                    "commandLineArguments": "",
                                    "showInPortal": true
                                }
                            },
                            {
                                "id": "[concat('/subscriptions/',subscription().id,'/resourcegroups/',resourceGroup().name, '/providers/Microsoft.DesktopVirtualization/applicationgroups/',variables('AADDRemoteAppGroupName'),'/applications/Outlook')]",
                                "name": "Outlook",
                                "type": "Microsoft.WindowsVirualDesktop/applicationGroups/applications",
                                "properties": {
                                    "applicationType": "Inbuilt",
                                    "friendlyName": "",
                                    "description": "",
                                    "filePath": "C:\\Program Files\\Microsoft Office\\root\\Office16\\OUTLOOK.EXE",
                                    "iconPath": "C:\\Program Files\\Microsoft Office\\Root\\VFS\\Windows\\Installer\\{90160000-000F-0000-1000-0000000FF1CE}\\outicon.exe",
                                    "iconIndex": 0,
                                    "commandLineSetting": "DoNotAllow",
                                    "commandLineArguments": "",
                                    "showInPortal": true
                                }
                            },
                            {
                                "id": "[concat('/subscriptions/',subscription().id,'/resourcegroups/',resourceGroup().name, '/providers/Microsoft.DesktopVirtualization/applicationgroups/',variables('AADDRemoteAppGroupName'),'/applications/PowerPoint')]",                        
                                "name": "PowerPoint",
                                "type": "Microsoft.WindowsVirualDesktop/applicationGroups/applications",
                                "properties": {
                                    "applicationType": "Inbuilt",
                                    "friendlyName": "",
                                    "description": "",
                                    "filePath": "C:\\Program Files\\Microsoft Office\\root\\Office16\\POWERPNT.EXE",
                                    "iconPath": "C:\\Program Files\\Microsoft Office\\Root\\VFS\\Windows\\Installer\\{90160000-000F-0000-1000-0000000FF1CE}\\pptico.exe",
                                    "iconIndex": 0,
                                    "commandLineSetting": "DoNotAllow",
                                    "commandLineArguments": "",
                                    "showInPortal": true
                                }
                            },
                            {
                                "id": "[concat('/subscriptions/',subscription().id,'/resourcegroups/',resourceGroup().name, '/providers/Microsoft.DesktopVirtualization/applicationgroups/',variables('AADDRemoteAppGroupName'),'/applications/Remote Desktop Connection')]",
                                "name": "Remote Desktop Connection",
                                "type": "Microsoft.WindowsVirualDesktop/applicationGroups/applications",
                                "properties": {
                                    "applicationType": "Inbuilt",
                                    "friendlyName": "",
                                    "description": "",
                                    "filePath": "C:\\Windows\\system32\\mstsc.exe",
                                    "iconPath": "C:\\Windows\\system32\\mstsc.exe",
                                    "iconIndex": 0,
                                    "commandLineSetting": "DoNotAllow",
                                    "commandLineArguments": "",
                                    "showInPortal": true
                                }
                            },
                            {
                                "id": "[concat('/subscriptions/',subscription().id,'/resourcegroups/',resourceGroup().name, '/providers/Microsoft.DesktopVirtualization/applicationgroups/',variables('AADDRemoteAppGroupName'),'/applications/Windows PowerShell ISE')]",
                                "name": "Windows PowerShell ISE",
                                "type": "Microsoft.WindowsVirualDesktop/applicationGroups/applications",
                                "properties": {
                                    "applicationType": "Inbuilt",
                                    "friendlyName": "",
                                    "description": "",
                                    "filePath": "C:\\Windows\\system32\\WindowsPowerShell\\v1.0\\PowerShell_ISE.exe",
                                    "iconPath": "C:\\Windows\\system32\\WindowsPowerShell\\v1.0\\powershell_ise.exe",
                                    "iconIndex": 0,
                                    "commandLineSetting": "DoNotAllow",
                                    "commandLineArguments": "",
                                    "showInPortal": true
                                }
                            },
                            {
                                "id": "[concat('/subscriptions/',subscription().id,'/resourcegroups/',resourceGroup().name, '/providers/Microsoft.DesktopVirtualization/applicationgroups/',variables('AADDRemoteAppGroupName'),'/applications/Word')]",
                                "name": "Word",
                                "type": "Microsoft.WindowsVirualDesktop/applicationGroups/applications",
                                "properties": {
                                    "applicationType": "Inbuilt",
                                    "friendlyName": "",
                                    "description": "",
                                    "filePath": "C:\\Program Files\\Microsoft Office\\root\\Office16\\WINWORD.EXE",
                                    "iconPath": "C:\\Program Files\\Microsoft Office\\Root\\VFS\\Windows\\Installer\\{90160000-000F-0000-1000-0000000FF1CE}\\wordicon.exe",
                                    "iconIndex": 0,
                                    "commandLineSetting": "DoNotAllow",
                                    "commandLineArguments": "",
                                    "showInPortal": true
                                }
                            }                    
                        ]
                    },            
                    "RoleAssignmentGUID": {
                        "value": "[parameters('roleAssignmentGuid2')]"
                    },
                    "PrincipalID": {
                        "value": "[parameters('AVDGroupObjectID')]"
                    },
                    "RoleDefinitionID": {
                        "value": "[variables('RoleDefinitionID')]"
                    }                                                                                                                                                                                                                                                                                                                                                                            
                }
            }
        },                
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Deploy-To-Workspace",   
            "dependsOn": [
                "Deploy-AzureVirtualDesktop-AADD-DesktopApplicationGroup",
                "Deploy-AzureVirtualDesktop-AADD-RemoteApplicationGroup"                         ],   
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/avdworkspace.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "AVDWorkSpaceAPIVersion": {
                        "value": "[variables('AVDWorkSpaceAPIVersion')]"
                    },                      
                    "WorkSpaceName": {
                        "value": "[variables('WorkSpaceName')]"
                    },  
                    "DesktopAppGroupName": {
                        "value": "[variables('AADDDesktopAppGroupName')]"
                    },
                    "RemoteAppGroupName": {
                        "value": "[variables('AADDRemoteAppGroupName')]"
                    }                                                          
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Deploy-AADD-SessionHost-Availability-Set",   
            "dependsOn": [
                "Deploy-To-Workspace"
            ],   
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/availabilityset.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "AvailabilitySetsAPIVersion": {
                        "value": "[variables('AvailabilitySetsAPIVersion')]"
                    },
                    "AvailabilitySetName": {
                        "value": "[variables('AADDAvailabilitySetName')]"
                    },
                    "availabilitySetUpdateDomainCount": {
                        "value": "[parameters('availabilitySetUpdateDomainCount')]"
                    },
                    "availabilitySetFaultDomainCount": {
                        "value": "[parameters('availabilitySetFaultDomainCount')]"
                    } 
                }
            }
        },                
        {
            "condition": "[equals(parameters('SHOSSku'),'win11-21h2-avd-m365')]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Deploy-AADD-SessionHosts-Win11-M365",   
            "dependsOn": [
                "Deploy-AADD-SessionHost-Availability-Set"
            ],   
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/aaddsessionhosts.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "NetworkInterfacesAPIVersion": {
                        "value": "[variables('NetworkInterfacesAPIVersion')]"
                    },
                    "VirtualMachinesAPIVersion": {
                        "value": "[variables('VirtualMachinesAPIVersion')]"
                    },                  
                    "ExtensionsAPIVersion": {
                        "value": "[variables('ExtensionsAPIVersion')]"
                    },
                    "ExtensionsTypeHandlerVersion": {
                        "value": "[variables('ExtensionsTypeHandlerVersion')]"
                    },
                    "DJExtensionsTypeHandlerVersion": {
                        "value": "[variables('DJExtensionsTypeHandlerVersion')]"
                    },                                        
                    "availabilitySetName": {
                        "value": "[variables('AADDAvailabilitySetName')]"
                    },
                    "TimeZone": {
                        "value": "[parameters('TimeZone')]"
                    },
                    "Publisher": {
                        "value": "MicrosoftWindowsDesktop"
                    },
                    "Offer": {
                        "value": "Office-365"
                    },
                    "OSSku": {
                        "value": "win11-21h2-avd-m365"
                    },                                          
                    "OSVersion": {
                        "value": "[parameters('SHOSVersion')]"
                    },              
                    "LicenseType": {
                        "value": "[parameters('WindowsClientLicenseType')]"
                    },              
                    "VMSize": {
                        "value": "[parameters('SHVMSize')]"
                    },
                    "vnetName": {
                        "value": "[variables('vnet1Name')]"
                    },            
                    "subnet1Name": {
                        "value": "[variables('vnet1subnet2Name')]"
                    },
                    
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },
                    "aaddsIP1": {
                        "value": "[variables('aaddsIP1')]"
                    },                                
                    "aaddsIP2": {
                        "value": "[variables('aaddsIP2')]"
                    },                                                                                              
                    "AzureUserName": {
                        "value": "[parameters('AzureUserName')]"
                    },
                    "AzureUserPassword": {
                        "value": "[parameters('AzureUserPassword')]"
                    },    
                    "rdshPrefix": {
                        "value": "[variables('aaddrdshPrefix')]"
                    },                                                                                                                                                                          
                    "rdshNumberOfInstances": {
                        "value": "[parameters('vmNumberOfInstances')]"
                    },
                    "vmInitialNumber": {
                        "value": "[parameters('vmInitialNumber')]"
                    },       
                    "hostpoolToken": {
                        "value": "[reference('Deploy-AzureVirtualDesktop-AADD-HostedPool').outputs.RegistrationInfoToken.value]"             
                    },             
                    "hostpoolName": {
                        "value": "[variables('AADDhostpoolName')]"
                    },
                    "domainName": {
                        "value": "[parameters('AzureADDomainServicesDomain')]"
                    },  
                    "ManagedDomainName": {
                        "value": "[parameters('ManagedDomainName')]"
                    },                                                            
                    "_artifactsLocation": {
                        "value": "[parameters('_artifactsLocation')]"
                    },                                                                                                            
                    "_artifactsLocationSasToken": {
                        "value": "[parameters('_artifactsLocationSasToken')]"
                    }                                                                                                                                                                                                                                                                                                
                }
            }
        },                
        {
            "condition": "[equals(parameters('SHOSSku'),'win10-21h2-avd-m365')]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Deploy-AADD-SessionHosts-Win10-M365",   
            "dependsOn": [
                "Deploy-AADD-SessionHost-Availability-Set"
            ],   
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('linkedtemplates/aaddsessionhosts.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "NetworkInterfacesAPIVersion": {
                        "value": "[variables('NetworkInterfacesAPIVersion')]"
                    },
                    "VirtualMachinesAPIVersion": {
                        "value": "[variables('VirtualMachinesAPIVersion')]"
                    },                    
                    "ExtensionsAPIVersion": {
                        "value": "[variables('ExtensionsAPIVersion')]"
                    },
                    "ExtensionsTypeHandlerVersion": {
                        "value": "[variables('ExtensionsTypeHandlerVersion')]"
                    },
                    "DJExtensionsTypeHandlerVersion": {
                        "value": "[variables('DJExtensionsTypeHandlerVersion')]"
                    },                      
                    "availabilitySetName": {
                        "value": "[variables('AADDAvailabilitySetName')]"
                    },
                    "TimeZone": {
                        "value": "[parameters('TimeZone')]"
                    },
                    "Publisher": {
                        "value": "MicrosoftWindowsDesktop"
                    },
                    "Offer": {
                        "value": "Office-365"
                    },
                    "OSSku": {
                        "value": "win10-21h2-avd-m365"
                    },                                          
                    "OSVersion": {
                        "value": "[parameters('SHOSVersion')]"
                    },              
                    "LicenseType": {
                        "value": "[parameters('WindowsClientLicenseType')]"
                    },              
                    "VMSize": {
                        "value": "[parameters('SHVMSize')]"
                    },
                    "vnetName": {
                        "value": "[variables('vnet1Name')]"
                    },            
                    "subnet1Name": {
                        "value": "[variables('vnet1subnet2Name')]"
                    },
                    "aaddsIP1": {
                        "value": "[variables('aaddsIP1')]"
                    },                                
                    "aaddsIP2": {
                        "value": "[variables('aaddsIP2')]"
                    },                                                    
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },                      
                    "AzureUserName": {
                        "value": "[parameters('AzureUserName')]"
                    },
                    "AzureUserPassword": {
                        "value": "[parameters('AzureUserPassword')]"
                    },  
                    "rdshPrefix": {
                        "value": "[variables('aaddrdshPrefix')]"
                    },                                                                                                                                                                          
                    "rdshNumberOfInstances": {
                        "value": "[parameters('vmNumberOfInstances')]"
                    },
                    "vmInitialNumber": {
                        "value": "[parameters('vmInitialNumber')]"
                    },       
                    "hostpoolToken": {
                        "value": "[reference('Deploy-AzureVirtualDesktop-AADD-HostedPool').outputs.RegistrationInfoToken.value]"             
                    },             
                    "hostpoolName": {
                        "value": "[variables('AADDhostpoolName')]"
                    },
                    "domainName": {
                        "value": "[parameters('AzureADDomainServicesDomain')]"
                    },
                    "ManagedDomainName": {
                        "value": "[parameters('ManagedDomainName')]"
                    },                                                                  
                    "_artifactsLocation": {
                        "value": "[parameters('_artifactsLocation')]"
                    },                                                                                                            
                    "_artifactsLocationSasToken": {
                        "value": "[parameters('_artifactsLocationSasToken')]"
                    }                                                                                                                                                                                                                                                                                                
                }
            }
        }                                                                                                                                                   
    ]
}